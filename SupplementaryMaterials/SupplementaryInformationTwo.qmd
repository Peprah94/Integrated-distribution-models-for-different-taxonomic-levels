---
title: "Supplementary Information 2"
author: "Kwaku Peprah Adjei"
bibliography: references.bib
format: pdf
editor: visual
---

```{r, message = FALSE, echo = FALSE, warning=FALSE, message = FALSE}
source("functionForEstimation.R")
library(kableExtra)
library(knitr)
theme_set(theme_classic(base_size = 20)) 
#theme_set(theme_map(base_size = 20))
#load data
parsEstimates <- read_csv("Figures/sigmaEstimates.csv")
shannonEstimates <- read_csv("Figures/shannonEstimates.csv")
rHatEstimates <- read_csv("Figures/rHatEstimates.csv")
```

#Species Association

![Species association correlation plot from the shared model. These were estimated from the variance-covariance matrix $\Sigma$ of the species interraction efeect defined in equations (1) and (2) in the main paper. The figure shows the values for the upper-triangular values and the species names are abbreviated to eight letters to makes the plots compact. A complete species list and abbreviations are provided in Table ...](Figures/speciesAssociationShared.png){#fig-speciesAssociationShared}

![Species association correlation plot from the covariate model. Species association correlation plot from the shared model. These were estimated from the variance-covariance matrix $\Sigma$ of the species interraction efeect defined in equations (1) and (2) in the main paper. The figure shows the values for the upper-triangular values and the species names are abbreviated to eight letters to makes the plots compact. A complete species list and abbreviations are provided in Table ...](Figures/speciesAssociationCovariate.png){#fig-speciesAssociationCovariate}

# Mean parameters

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height=10, fig.width=15}
#| label: fig-muPlot
#| fig-cap: "Error plot showing the posterior mean of mean hyperparameters (mean of the intercept (muSites), mean of latitude effect (muLatitude), mean of site effect on detection probability (muAlphaSites)  and mean of species effect on detection probability (muAlphaSpecies)) in the model"


parsEstimates%>%
  filter(!grepl("rho|sigma",variable))%>%
  mutate(value = ifelse((variable %in% c("muAlphaSites", "muAlphaSpecies", "muSpecies") & method == "Group only"), NA, value))%>%
  ggplot( aes(x=insects, y=value, col=as.factor(method),  shape = as.factor(method))) +
  geom_point(position=position_dodge(0.5))+
  geom_errorbar(aes(ymin=value-sd, ymax=value+sd), width=0.5,
                position=position_dodge(0.5))+
  facet_grid(variable ~ model, scales = "free_y")+
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  xlab("Parameter")+
  ylab(expression(paste("Posterior mean" %+-% "SE")))+
  theme_classic()+
  coord_trans()+
  theme(legend.position = "bottom", legend.title = element_blank(),
        strip.placement = 'outside',
        strip.background = element_rect(colour = "black", fill = "white"),
        text = element_text(size = 20))+
  scale_color_discrete(labels=c('GCM', 'IDM', 'SOM'))+
  scale_shape_discrete(labels=c('GCM', 'IDM', 'SOM'))
```

#SD parameters

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height=10, fig.width=15}
#| label: fig-sigmaPlot
#| fig-cap: "Error plot showing the posterior standard deviation of hyperparameters ( intercept (sigmaSites), latitude effect (sigmaLatitude), site effect on detection probability (sigmaAlphaSites)  and species effect on detection probability (sigmaAlphaSpecies)) in the model"
#| 
#sigma estimates
  #remove "sigmaSpecies" after new results
  parsEstimates%>%
    filter(!grepl("rho|mu",variable))%>%
    mutate(value = ifelse((variable %in% c("sigmaAlphaSites", "sigmaAlphaSpecies", "sigmaSpecies") & method == "Group only"), NA, value))%>%
    ggplot( aes(x=insects, y=value, col=as.factor(method), shape=as.factor(method))) +
    geom_point(position=position_dodge(0.5))+
    geom_errorbar(aes(ymin=value-sd, ymax=value+sd), width=.5,
                  position=position_dodge(0.5))+
    facet_grid(variable ~ model, scales = "free_y")+
    scale_x_discrete(guide = guide_axis(angle = 45)) +
    xlab("Parameter")+
    ylab(expression(paste("Posterior mean" %+-% "SE")))+
  theme_classic()+
    coord_trans()+
    theme(legend.position = "bottom", legend.title = element_blank(),
          strip.placement = 'outside',
          strip.background = element_rect(colour = "black", fill = "white"),
        text = element_text(size = 20))+
    scale_color_discrete(labels=c('GCM', 'IDM', 'SOM'))+
    scale_shape_discrete(labels=c('GCM', 'IDM', 'SOM'))
```

# Rho estimate

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height=10, fig.width=15}
#| label: fig-rhoPlot
#| fig-cap: "Error plot of the overdispersion parameter estimated from the group count model (GCM) and integrated distribution model (IDM) for all bumblebees, solitary bees and hoverflies insect groups. The error plots are facetted with the type of joint likelihood link."
parsEstimates%>%
    filter(!grepl("sigma|mu",variable))%>%
    mutate(value = ifelse(method == "Species Only", NA, value))%>%
    ggplot( aes(x=insects, y=value, col=as.factor(method), shape = as.factor(method))) +
    geom_point(position=position_dodge(0.5))+
    geom_errorbar(aes(ymin=value-sd, ymax=value+sd), width=.5,
                  position=position_dodge(0.5))+
    facet_grid(. ~ model)+
    scale_x_discrete(guide = guide_axis(angle = 45)) +
    xlab("Insect group")+
    ylab(expression(paste("Posterior mean" %+-% "SE")))+
    theme_classic()+
    coord_trans()+
    theme(legend.position = "bottom", legend.title = element_blank(),
          strip.placement = 'outside',
          strip.background = element_rect(colour = "black", fill = "white"), text = element_text(size = 20))+
    scale_color_discrete(labels=c('GCM', 'IDM', 'SOM'))+
    scale_shape_discrete(labels=c('GCM', 'IDM', 'SOM'))
```

#Shannon Index

## Average Shannon Index

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height=10, fig.width=15}
#| label: fig-averageShannonPlot
#| fig-cap: "Error plots of average Shannon diversity index across the 74 PoMS sites. The width of the bar shows their standard deviation of the posterior average Shannon diversity of the 74 sites. The plot is facetted by the type of the joint likelihood link."
 averageShannon <- shannonEstimates%>%
    group_by(insects, method, model) %>%
    summarise(average = mean(mean),
              sd = sd(mean))%>%
    ungroup()%>%
    ggplot( aes(x=insects, y=average, col=as.factor(method))) +
    geom_point(position=position_dodge(0.5))+
    geom_errorbar(aes(ymin=average-sd, ymax=average+sd), width=.5,                 position=position_dodge(0.5))+
    facet_grid(~model)+
    scale_x_discrete(guide = guide_axis(angle = 45)) +
    xlab("Parameter")+
    ylab(expression(paste("Posterior mean" %+-% "SE")))+
    theme_classic()+
    coord_trans()+
  theme(legend.position = "bottom", legend.title = element_blank(),
        strip.placement = 'outside',
        strip.background = element_rect(colour = "black", fill = "white"),
        text = element_text(size = 20))

 averageShannon

```

## Bumblebees Shannon plot

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height=10, fig.width=15}
#| label: fig-bbShannonPlot
#| fig-cap: "Posterior mean of average Shannon of Bumblebees. Add some more text"
 
 
  UK_countries_lowres@data$ID = rownames(UK_countries_lowres@data)
  UK_countries_lowres_df <- ggplot2::fortify(UK_countries_lowres)

  shannonMap <- lapply(as.list(c("Bumblebees", "Hoverflies" , "Solitary bees")), function(x){
    ggplot(data = shannonEstimates%>%
             filter(insects == x) ) +
      geom_polygon(data = UK_countries_lowres_df,
                   aes(x = long, y = lat, group = group),
                   fill = "gray93", colour = "black") +
      geom_point(aes(x = EASTING, y = NORTHING,
                     fill = mean), shape = 22, size = 5,
                 color = "gray") +
      facet_grid(model~ method) +
  theme(legend.position = "bottom", #legend.title = element_blank(),
        strip.placement = 'outside',
        strip.background = element_rect(colour = "black", fill = "white"),
        text = element_text(size = 24))+
      theme_map(font_size = 20) +
      coord_equal() +
      scale_fill_viridis_c(name = "Shannon")
  })
  
  
   shannonMapSD <- lapply(as.list(c("Bumblebees", "Hoverflies" , "Solitary bees")), function(x){
    ggplot(data = shannonEstimates%>%
             filter(insects == x) ) +
      geom_polygon(data = UK_countries_lowres_df,
                   aes(x = long, y = lat, group = group),
                   fill = "gray93", colour = "black") +
      geom_point(aes(x = EASTING, y = NORTHING,
                     fill = sd), shape = 22, size = 5,
                 color = "gray") +
      facet_grid(model~ method) +
      theme(legend.position = "bottom", #legend.title = element_blank(),
            strip.placement = 'outside',
            strip.background = element_rect(colour = "black", fill = "white"),
            text = element_text(size = 24))+
      theme_map(font_size = 20) +
      coord_equal() +
      scale_fill_viridis_c(name = "Shannon")
  }) 
  

  shannonMap[[1]]
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height=10, fig.width=15}
#| label: fig-bbShannonPlotSD
#| fig-cap: "Posterior standard deviation of average Shannon of Bumblebees. Add some more text"
shannonMapSD[[1]]
```

## Hoverflies Shannon plot

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height=10, fig.width=15}
#| label: fig-hvShannonPlot
#| fig-cap: "Posterior mean of average Shannon of hoverflies. Add some more text"
shannonMap[[2]]
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height=10, fig.width=15}
#| label: fig-hvShannonPlotSD
#| fig-cap: "Posterior standard deviation of average Shannon of hoverflies. Add some more text"
shannonMapSD[[2]]
```

## Solitary bees

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height=10, fig.width=15}
#| label: fig-sbShannonPlot
#| fig-cap: "Posterior mean of average Shannon of solitary bees. Add some more text"
shannonMap[[3]]
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height=10, fig.width=15}
#| label: fig-sbShannonPlotSD
#| fig-cap: "Posterior standard deviation of average Shannon of solitarybees. Add some more text"
shannonMapSD[[3]]
```

# Convergence plot

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height=10, fig.width=15}
#| label: fig-rhatPlot
#| fig-cap: "Rhat values parameters for  Add some more text"
rHatEstimates%>%
  filter(!grepl("Cov|shan",Parameter))%>%
  mutate(method = rep(rep(c("IDM" , "Group only", "Species Only"), each = 9*2), 3),
         insects = rep(c("Bumblebees", "Hoverflies", "Solitary bees"),
                       each= 54),
         model = rep(rep(c("shared", "covariate"),each = 9),9))%>%
  ggplot(aes(x = Rhat, y = Parameter, col = method))+
  geom_point(position=position_dodge(0.5))+
  geom_vline(xintercept = 1.1, line_type = "dashed", col = "red")+
  facet_grid(model ~ insects)+
  theme_classic()+
    theme(legend.position = "bottom", legend.title = element_blank(),
        strip.placement = 'outside',
        strip.background = element_rect(colour = "black", fill = "white"),
        text = element_text(size = 20))
```
